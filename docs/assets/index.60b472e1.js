var z=Object.defineProperty;var p=Object.getOwnPropertySymbols;var b=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var m=(r,t,e)=>t in r?z(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,d=(r,t)=>{for(var e in t||(t={}))b.call(t,e)&&m(r,e,t[e]);if(p)for(var e of p(t))M.call(t,e)&&m(r,e,t[e]);return r};const v=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}};v();class a{constructor(t=0,e=0,s=0,i=1){this.r=t,this.g=e,this.b=s,this.a=i}static get red(){return new a(1,0,0)}static get green(){return new a(0,1,0)}static get blue(){return new a(0,0,1)}static get yellow(){return new a(1,1,0)}static get cyan(){return new a(0,1,1)}static get fuschia(){return new a(1,0,1)}static get black(){return new a(0,0,0)}static get gray(){return new a(.5,.5,.5)}static get white(){return new a(1,1,1)}static get transparent(){return new a(0,0,0,0)}add(t){return t instanceof a?(this.r+=t.r,this.g+=t.g,this.b+=t.b):(this.r+=t,this.g+=t,this.b+=t),this}mul(t){return t instanceof a?(this.r*=t.r,this.g*=t.g,this.b*=t.b):(this.r*=t,this.g*=t,this.b*=t),this}copy(){return new a(this.r,this.g,this.b,this.a)}}class S{constructor(t,e=a.white){this.position=t,this.color=e}contribution(t){const e=t.ray.direction,s=this.position.copy().sub(t.position).normalize(),i=this.calculateDiffuse(s,t.normal),n=this.fastPhong(e,s,t.normal),o=t.material.color,h=this.color;return{diffuse:new a(o.r*i,o.g*i,o.b*i),specular:new a(h.r*n,h.g*n,h.b*n)}}calculateDiffuse(t,e){return Math.max(0,t.dot(e))}calculatePhong(t,e,s,i=50){const n=e.copy().reflect(s);return Math.max(0,n.dot(t))**i}fastPhong(t,e,s,i=50){const n=e.copy().inverse().add(t).normalize();return Math.max(0,-n.dot(s))**(i*2)}}class P{constructor(t){this.material=t}}class y{constructor(t=a.gray,e=.5,s=0){this.color=t,this.shine=e,this.gloss=s}}class L{constructor(t,e,s,i){this.ray=t,this.t=e,this.material=s,this.normal=i,this.position=this.ray.direction.copy().mul(this.t).add(this.ray.origin)}}class q extends P{constructor(t,e,s=new y){super(s),this.center=t,this.radius=e,this.material=s}intersect(t){const e=this.center.copy().sub(t.origin),s=t.direction.dot(e);if(s<=0)return null;const i=e.dot(e)-s**2,n=this.radius**2;if(i>n)return null;const o=Math.sqrt(n-i),h=s-o,u=t.direction.copy().mul(h).add(t.origin);return new L(t,h,this.material,u.sub(this.center).normalize())}}class O{async renderSequence(t){for(;t.hasNext();)this.render(await t.next())}}class R{constructor(t,e){this.origin=t,this.direction=e}}class c{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}static get up(){return new c(0,1,0)}static get down(){return new c(0,-1,0)}static get left(){return new c(-1,0,0)}static get right(){return new c(1,0,0)}static get forward(){return new c(0,0,1)}static get back(){return new c(0,0,-1)}static get zero(){return new c(0,0,0)}static get one(){return new c(1,1,1)}static randomUnit(){return new c(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize()}add(t){return t instanceof c?(this.x+=t.x,this.y+=t.y,this.z+=t.z):(this.x+=t,this.y+=t,this.z+=t),this}sub(t){return t instanceof c?(this.x-=t.x,this.y-=t.y,this.z-=t.z):(this.x-=t,this.y-=t,this.z-=t),this}mul(t){return t instanceof c?(this.x*=t.x,this.y*=t.y,this.z*=t.z):(this.x*=t,this.y*=t,this.z*=t),this}div(t){return t instanceof c?(this.x/=t.x,this.y/=t.y,this.z/=t.z):(this.x/=t,this.y/=t,this.z/=t),this}inverse(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}copy(){return new c(this.x,this.y,this.z)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}reflect(t){return this.copy().sub(t.copy().mul(2*this.dot(t)))}get length(){return Math.sqrt(this.dot(this))}normalize(){const t=this.length;return this.x/=t,this.y/=t,this.z/=t,this}}const I=.017453292519943295;class B{constructor(t){this.fieldOfView=t,this.fovTan=t/2*I}rayForPixel(t,e,s,i){const n=s/2,o=i/2,h=new c(Math.tan(this.fovTan*((t-n)/n)),Math.tan(this.fovTan*((o-e)/o)*(i/s)),1).normalize();return new R(c.zero,h)}}class D{trace(t,e,s=0){const i=t.intersect(e);if(i){let n=new a;return t.eachLight(o=>{const h=o.contribution(i);n.add(h.diffuse),n.add(h.specular)}),n}else return t.background}}const N={fieldOfView:90};class T extends O{constructor(t){super(),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.raytracer=new D,this.exposure=1;const e=d(d({},N),t);this.camera=new B(e.fieldOfView),this.frameBuffer=new Uint8ClampedArray(e.width*e.height*4),this.resize(e.width,e.height),Object.assign(this.canvas.style,{position:"fixed",top:"50%",left:0,transform:"translateY(-50%)",width:"100%",height:"auto"}),document.body.appendChild(this.canvas)}resize(t,e){this.canvas.width=t,this.canvas.height=e}render(t){if(!this.context)return;const{width:e,height:s}=this.canvas;for(let i=0;i<s;i++)for(let n=0;n<e;n++){const o=this.camera.rayForPixel(n,i,e,s),h=this.raytracer.trace(t,o),u=(i*e+n)*4;this.exposure=Math.min(this.exposure,1/h.r,1/h.g,1/h.b),this.frameBuffer[u+0]=Math.round(h.r*255*this.exposure),this.frameBuffer[u+1]=Math.round(h.g*255*this.exposure),this.frameBuffer[u+2]=Math.round(h.b*255*this.exposure),this.frameBuffer[u+3]=Math.round(h.a*255)}this.context.putImageData(new ImageData(this.frameBuffer,e,s),0,0)}}class k{constructor(){this.background=new a,this.shapes=[],this.lights=[]}addShape(t){return this.shapes.push(t),t}addLight(t){return this.lights.push(t),t}eachLight(t){this.lights.forEach(t)}intersect(t,e=1/0){let s=null;for(const i of this.shapes){const n=i.intersect(t);!n||(!s||(n==null?void 0:n.t)<(s==null?void 0:s.t))&&(s=n)}return s&&(s==null?void 0:s.t)>e?null:s}}class F{}class A extends F{constructor(t){super(),this.scene=t}hasNext(){return!0}async next(){return new Promise(t=>{requestAnimationFrame(()=>{this.onStep&&this.onStep(this.scene),t(this.scene)})})}}const g=new k,f=g.addShape(new q(new c(180,0,500),100,new y(new a(.2,.85,1)))),w=g.addLight(new S(new c(-500,0,250))),E=new T({width:360,height:240}),x=new A(g);let l=0;x.onStep=()=>{l+=.01,f.center.x=Math.sin(l)*500,w.position.x=f.center.x+Math.sin(l+Math.PI)*500,w.position.z=f.center.z+Math.cos(l+Math.PI)*500};E.renderSequence(x);
