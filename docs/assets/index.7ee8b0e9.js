var B=Object.defineProperty;var P=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable;var R=(r,t,e)=>t in r?B(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,z=(r,t)=>{for(var e in t||(t={}))I.call(t,e)&&R(r,e,t[e]);if(P)for(var e of P(t))E.call(t,e)&&R(r,e,t[e]);return r};const A=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}};A();class c{constructor(t=0,e=0,s=0,i=1){this.r=t,this.g=e,this.b=s,this.a=i}static get red(){return new c(1,0,0)}static get green(){return new c(0,1,0)}static get blue(){return new c(0,0,1)}static get yellow(){return new c(1,1,0)}static get cyan(){return new c(0,1,1)}static get fuschia(){return new c(1,0,1)}static get black(){return new c(0,0,0)}static get gray(){return new c(.5,.5,.5)}static get white(){return new c(1,1,1)}static get transparent(){return new c(0,0,0,0)}add(t){return t instanceof c?(this.r+=t.r,this.g+=t.g,this.b+=t.b):(this.r+=t,this.g+=t,this.b+=t),this}mul(t){return t instanceof c?(this.r*=t.r,this.g*=t.g,this.b*=t.b):(this.r*=t,this.g*=t,this.b*=t),this}copy(){return new c(this.r,this.g,this.b,this.a)}}class O{constructor(t,e=c.white){this.position=t,this.color=e}contribution(t){const e=t.ray.direction,s=this.position.copy().sub(t.position).normalize(),i=this.calculateDiffuse(s,t.normal),n=this.fastPhong(e,s,t.normal),a=t.material.color,o=this.color;return{diffuse:new c(a.r*this.color.r*i,a.g*this.color.g*i,a.b*this.color.b*i),specular:new c(o.r*n,o.g*n,o.b*n)}}calculateDiffuse(t,e){return Math.max(0,t.dot(e))}calculatePhong(t,e,s,i=50){const n=e.copy().reflect(s);return Math.max(0,n.dot(t))**i}fastPhong(t,e,s,i=50){const n=e.copy().inverse().add(t).normalize();return Math.max(0,-n.dot(s))**(i*2)}}class F{constructor(t){this.material=t}}class k{constructor(t=c.gray,e=.2,s=.03){this.color=t,this.shine=e,this.gloss=s}}class C{constructor(t,e,s,i){this.ray=t,this.t=e,this.material=s,this.normal=i,this.position=this.ray.direction.copy().mul(this.t).add(this.ray.origin)}}class L extends F{constructor(t,e,s=new k){super(s),this.center=t,this.radius=e,this.material=s}intersect(t){const e=this.center.copy().sub(t.origin),s=t.direction.dot(e);if(s<=0)return null;const i=e.dot(e)-s**2,n=this.radius**2;if(i>n)return null;const a=Math.sqrt(n-i),o=s-a,d=t.direction.copy().mul(o).add(t.origin).sub(this.center).normalize();return new C(t,o,this.material,d)}}class q{async renderSequence(t){for(;t.hasNext();)this.render(await t.next())}}class U{constructor(t,e){this.origin=t,this.direction=e}}class u{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}static get up(){return new u(0,1,0)}static get down(){return new u(0,-1,0)}static get left(){return new u(-1,0,0)}static get right(){return new u(1,0,0)}static get forward(){return new u(0,0,1)}static get back(){return new u(0,0,-1)}static get zero(){return new u(0,0,0)}static get one(){return new u(1,1,1)}static randomUnit(){return new u(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1).normalize()}add(t){return t instanceof u?(this.x+=t.x,this.y+=t.y,this.z+=t.z):(this.x+=t,this.y+=t,this.z+=t),this}sub(t){return t instanceof u?(this.x-=t.x,this.y-=t.y,this.z-=t.z):(this.x-=t,this.y-=t,this.z-=t),this}mul(t){return t instanceof u?(this.x*=t.x,this.y*=t.y,this.z*=t.z):(this.x*=t,this.y*=t,this.z*=t),this}div(t){return t instanceof u?(this.x/=t.x,this.y/=t.y,this.z/=t.z):(this.x/=t,this.y/=t,this.z/=t),this}inverse(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}copy(){return new u(this.x,this.y,this.z)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}reflect(t){return this.copy().sub(t.copy().mul(2*this.dot(t)))}get length(){return Math.sqrt(this.dot(this))}normalize(){const t=this.length;return this.x/=t,this.y/=t,this.z/=t,this}}const $=.017453292519943295;class N{constructor(t=90){this.fieldOfView=t,this.position=u.zero,this.fovScale=t*.5*$}rayForPixel(t,e,s,i){const n=s/2,a=i/2,o=this.fovScale,h=this.fovScale*(i/s),d=(t-n)/n*o,l=(e-a)/a*h,w=new u(Math.sin(d)*Math.cos(l),Math.sin(-l),Math.cos(d)*Math.cos(l));return new U(this.position,w)}}class X{constructor(t=3){this.maxBounces=t}trace(t,e,s=0){const i=t.intersect(e);if(i){let n=new c;if(s<this.maxBounces){const a=new U(i.position,e.direction.reflect(i.normal));n=this.trace(t,a,s+1).mul(i.material.gloss)}return t.eachLight(a=>{const o=a.contribution(i);n.add(o.diffuse),n.add(o.specular.mul(i.material.shine))}),n}else return t.getColor(e.direction)}}const T={fieldOfView:75};class Y extends q{constructor(t){super(),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.raytracer=new X,this.exposure=1;const e=z(z({},T),t);this.camera=new N(e.fieldOfView),this.frameBuffer=new Uint8ClampedArray(e.width*e.height*4),this.resize(e.width,e.height),Object.assign(this.canvas.style,{position:"fixed",top:"50%",left:0,transform:"translateY(-50%)",width:"100%",height:"auto"}),document.body.appendChild(this.canvas)}resize(t,e){this.canvas.width=t,this.canvas.height=e}render(t){if(!this.context)return;const{width:e,height:s}=this.canvas;for(let i=0;i<s;i++)for(let n=0;n<e;n++){const a=this.camera.rayForPixel(n,i,e,s),o=this.raytracer.trace(t,a),h=(i*e+n)*4;this.frameBuffer[h+0]=Math.round(o.r*255*this.exposure),this.frameBuffer[h+1]=Math.round(o.g*255*this.exposure),this.frameBuffer[h+2]=Math.round(o.b*255*this.exposure),this.frameBuffer[h+3]=Math.round(o.a*255)}this.context.putImageData(new ImageData(this.frameBuffer,e,s),0,0)}}class H{constructor(){this.background=new c,this.shapes=[],this.lights=[]}addShape(t){return this.shapes.push(t),t}addLight(t){return this.lights.push(t),t}eachLight(t){this.lights.forEach(t)}intersect(t,e=1/0){let s=null;for(const i of this.shapes){const n=i.intersect(t);!n||(!s||(n==null?void 0:n.t)<(s==null?void 0:s.t))&&(s=n)}return s&&(s==null?void 0:s.t)>e?null:s}getColor(t){return this.background instanceof c?this.background:this.background.sample(t)}}class W{}class j extends W{constructor(t){super(),this.scene=t,this.pause=!1}hasNext(){return!0}async next(){return new Promise(async t=>{this.onStep&&this.onStep(this.scene),this.pause&&await new Promise(e=>{const s=setInterval(()=>{this.pause||(clearInterval(s),e())},100)}),requestAnimationFrame(()=>{t(this.scene)})})}}function f(r,t,e){return r+e*(t-r)}function m(r,t,e){return r<t?e+r%e:r%e}class G{constructor(){this.width=0,this.height=0,this.bilinear=!0}sample(t){const e=Math.acos(t.y),i=Math.atan2(t.x,t.z)/(2*Math.PI),n=e/Math.PI,a=i*this.width,o=n*this.height;if(this.bilinear&&(a%1!==0||o%1!==0)){const h=m(a,0,1),d=m(o,0,1),l=this.getPixel(a,o),w=this.getPixel(a+1,o),M=this.getPixel(a,o+1),v=this.getPixel(a+1,o+1);return new c(f(f(l.r,w.r,h),f(M.r,v.r,h),d),f(f(l.g,w.g,h),f(M.g,v.g,h),d),f(f(l.b,w.b,h),f(M.b,v.b,h),d))}return this.getPixel(a,o)}}function K(r){return[...r.readBytes(11)].map(s=>String.fromCharCode(s)).join("")===`#?RADIANCE
`}function J(r){const t=[],e={};for(;;){const s=r.readLine();if(s.length===0)break;t.push(s)}return t.forEach(s=>{if(s.startsWith("#")||s.length===0)return;const i=s.indexOf("="),n=s.slice(0,i),a=s.slice(i+1);switch(n){case"FORMAT":e.FORMAT=a;break;case"GAMMA":e.GAMMA=parseFloat(a);break;case"EXPOSURE":e.EXPOSURE=parseFloat(a);break;case"COLORCORR":const o=a.split(" ").map(h=>parseFloat(h));e.COLORCORR=o;break;default:console.warn(`Unrecognized header in HDR image: ${s}`)}}),e}function Q(r){const e=r.readLine().split(" "),s={yDir:-1,xDir:1,width:0,height:0};return e.forEach((i,n)=>{i=="-Y"?s.yDir=-1:i=="+Y"?s.yDir=1:i=="-X"?s.xDir=-1:i=="+X"?s.xDir=1:e[n-1].endsWith("X")?s.width=parseInt(i):s.height=parseInt(i)}),s}function Z(r,t,e){const s=new Float32Array(t*e*3);for(let i=0;i<e;i++){const n=V(r,t);for(let a=0;a<t;a++){const[o,h,d]=_(n,a),l=(i*t+a)*3;s[l+0]=o,s[l+1]=h,s[l+2]=d}}return s}function V(r,t){const e=new Uint8Array(t*4),s=r.readUint16();if(s!==514)throw r.rewind(2),new Error(`Invalid scanline header: ${s}, expected ${514}`);const i=r.readUint16();if(i!==t)throw new Error(`Invalid scanline width: ${i}, expected ${t}`);return y(r,e,0),y(r,e,1),y(r,e,2),y(r,e,3),e}function y(r,t,e){for(let s=0;s<t.length/4;){const i=r.readByte();let n=e+s*4;if(i>128){const a=i-128,o=r.readByte();for(let h=0;h<a;h++)t[n]=o,s++,n+=4}else for(let a=0;a<i;a++)t[n]=r.readByte(),s++,n+=4}}function _(r,t){const e=r[t*4+3],s=e?Math.pow(2,e-136):0,i=r[t*4+0]*s,n=r[t*4+1]*s,a=r[t*4+2]*s;return[i,n,a]}class tt{constructor(t){this.pointer=0,this.view=new DataView(t)}seek(t){this.pointer=t}rewind(t){this.pointer-=t}skip(t){this.pointer+=t}readUint8(){const t=this.peekUint8();return this.pointer+=1,t}peekUint8(){return this.view.getUint8(this.pointer)}readByte(){return this.readUint8()}readBytes(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=this.readByte();return e}peekByte(){return this.peekUint8()}readUint16(){const t=this.peekUint16();return this.pointer+=2,t}peekUint16(){return this.view.getUint16(this.pointer)}readLine(){let t="",e="";for(;t!==`
`;)e+=t,t=String.fromCharCode(this.readUint8());return e}}class et extends G{constructor(){super(...arguments),this.width=0,this.height=0,this.data=new Float32Array,this.header={},this.xDir=1,this.yDir=-1}async load(t){let e;if(typeof t=="string"){const i=await fetch(t);if(!i.ok)throw new Error(`Failed to load HDR image (${i.status}): ${t}`);e=await i.arrayBuffer()}else e=t;const s=new tt(e);if(!K(s))throw new Error(`Invalid HDR image, first bytes don't match: ${t}`);this.header=J(s),Object.assign(this,Q(s)),this.data=Z(s,this.width,this.height)}getPixel(t,e){const s=Math.floor(m(t,0,this.width)),n=(Math.floor(m(e,0,this.width))*this.width+s)*3,a=this.data[n+0],o=this.data[n+1],h=this.data[n+2];return new c(a,o,h)}}const g=new H,x=new et;x.load("HDR_029_Sky_Cloudy_Env.hdr");g.background=x;const S=g.addShape(new L(new u(180,0,500),100,new k(new c(.2,.85,1)))),st=g.addShape(new L(new u(180,0,600),100,new k(new c(.88,.85,1),.8,.5)));g.addLight(new O(new u(-1e3,3e4,-25e3),new c(.8,.8,.8)));const D=g.addLight(new O(new u(-500,0,250),new c(.4,.4,.4))),it=new Y({width:360,height:240}),b=new j(g);let p=0;b.onStep=()=>{p+=.01,S.center.x=Math.sin(p*2)*500,st.center.y=Math.sin(p*2)*500,D.position.x=S.center.x+Math.sin(p+Math.PI)*500,D.position.z=S.center.z+Math.cos(p+Math.PI)*500};document.addEventListener("keydown",r=>{r.key.toLowerCase()==="i"&&(x.bilinear=!x.bilinear),r.key===" "&&(b.pause=!b.pause)});it.renderSequence(b);
